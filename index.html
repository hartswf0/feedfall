<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>The Liminal Archive â€” VHS Stacks (Ultra VCR Â· Multiâ€‘Views)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Newsreader:opsz,wght@6..72,600&family=VT323&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0d0f;      /* auditorium dark */
    --ink:#e9efe7;     /* archival paper */
    --accent:#21ff86;  /* diode green */
    --ghost:#aab4ad;   /* secondary copy */
    --amber:#ffdca8;   /* leader warmth */
    --edge:#12201a;    /* hardware edge */
    --warn:#ff4b72;    /* eject/warn */
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--ink); overflow:hidden; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial}
  canvas{display:block; width:100vw; height:100vh; touch-action:none}

  /* Global scan overlay now subtle, to keep labels crisp */
  #fx{pointer-events:none; position:fixed; inset:0; mix-blend-mode:overlay; background:repeating-linear-gradient( to bottom, rgba(255,255,255,.025) 0 1px, rgba(0,0,0,0) 2px 3px ); opacity:.06; z-index:5}

  /* ---------- Floating CRT TV overlay (diegetic preview) ---------- */
  #tv{ position:fixed; left:50%; top:10px; transform:translateX(-50%); width:min(94vw, 1040px); aspect-ratio:16/9; z-index:40; display:none; }
  #tv.show{ display:block; }

  /* chassis */
  #tv .bezel{ position:absolute; inset:0; border-radius:22px; background:linear-gradient(180deg,#0b0f13,#070a0c); box-shadow:0 20px 50px rgba(0,0,0,.65), inset 0 0 0 3px #0f151a, inset 0 0 0 6px #0a0e12; }
  #tv .badge{ position:absolute; left:20px; bottom:14px; font:700 12px Inter,system-ui; letter-spacing:.08em; color:#c7d3cb; opacity:.65 }
  #tv .speaker{ position:absolute; right:16px; bottom:12px; width:88px; height:54px; border-radius:10px; background:radial-gradient(circle at 20% 20%, #192126, #0b0f13); box-shadow:inset 0 0 0 1px #10161a; mask:radial-gradient(circle 2px at 6px 6px, #000 99%, transparent) repeat; -webkit-mask:radial-gradient(circle 2px at 6px 6px, #000 99%, transparent) repeat; mask-size:10px 10px; -webkit-mask-size:10px 10px; opacity:.9 }

  /* screen group (adds curvature, scanlines, glow and jitter ONLY here) */
  #tv .screen{ position:absolute; inset:14px 14px 66px 14px; border-radius:14px; overflow:hidden; }
  #tv .screen-wrap{ position:absolute; inset:0; filter:contrast(1.08) saturate(1.02); animation:crtJitter 3.6s infinite steps(1,end); }
  #tv iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; background:#060809; }
  /* phosphor mask */
  #tv .mask{ pointer-events:none; position:absolute; inset:0; mix-blend-mode:screen; background:
       repeating-linear-gradient(to right, rgba(255,60,80,.06), rgba(255,60,80,.06) 1px, rgba(0,0,0,0) 1px, rgba(0,0,0,0) 2px),
       repeating-linear-gradient(to right, rgba(60,180,255,.06), rgba(60,180,255,.06) 1px, rgba(0,0,0,0) 1px, rgba(0,0,0,0) 2px),
       repeating-linear-gradient(to right, rgba(120,255,120,.06), rgba(120,255,120,.06) 1px, rgba(0,0,0,0) 1px, rgba(0,0,0,0) 2px);
       opacity:.55 }
  /* scanlines + glass */
  #tv .scan{ pointer-events:none; position:absolute; inset:0; background:repeating-linear-gradient(to bottom, rgba(255,255,255,.06) 0 1px, transparent 2px 3px); opacity:.22; mix-blend-mode:overlay }
  #tv .glass{ pointer-events:none; position:absolute; inset:0; background:linear-gradient(15deg, rgba(255,255,255,.10), transparent 35%), radial-gradient(ellipse at 50% 120%, rgba(255,255,255,.06), transparent 60%); }
  #tv .vignette{ pointer-events:none; position:absolute; inset:0; box-shadow:inset 0 0 120px rgba(0,0,0,.55); border-radius:14px }
  #tv .glow{ pointer-events:none; position:absolute; inset:0; box-shadow:0 0 42px rgba(33,255,134,.15); border-radius:16px; animation:crtBloom 2.8s ease-in-out infinite; }

  /* bottom bar */
  #tv .bar{ position:absolute; left:14px; right:14px; bottom:12px; height:44px; display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; background:linear-gradient(180deg,#0a1014,#0c1116); box-shadow: inset 0 0 0 1px #1a2a26; }
  #tv .title{ flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:14px; opacity:.95 }
  #tv .btn{ border:1px solid #1f2f2a; background:#0e1419; color:#e9efe7; padding:8px 12px; border-radius:8px; font-weight:700; font-size:12px; letter-spacing:.3px; }
  #tv .btn.primary{ background:#112018; border-color:#204835; color:#bfffe2 }
  #tv .btn.warn{ background:#1a0e12; border-color:#5a1b2a; color:#ffd3df }

  /* accessibility-only dialog retained */
  #controller{ position:fixed; inset:0; display:none }
  #controller[hidden]{ display:none }
  .vt{ font-family:'VT323', ui-monospace, monospace }

  @keyframes crtJitter { 0%,97%,100% { transform:translate(0,0) } 50.5% { transform:translate(0.5px,0) } 51%{ transform:translate(-0.5px,0) } }
  @keyframes crtBloom { 0%,100%{ opacity:.18 } 50%{ opacity:.28 } }

  @media (prefers-reduced-motion: reduce){ #fx{ opacity:.03 } #tv .screen-wrap{ animation:none } #tv .glow{ animation:none } }
</style>
</head>
<body>
  <canvas id="c"></canvas>
  <div id="fx"></div>

  <!-- TV overlay (screen/preview on top) -->
  <div id="tv" aria-live="polite">
    <div class="bezel"></div>
    <div class="screen">
      <div class="screen-wrap">
        <iframe id="tvFrame" title="preview" sandbox="allow-scripts allow-same-origin allow-popups" referrerpolicy="no-referrer"></iframe>
        <div class="mask"></div>
        <div class="scan"></div>
        <div class="glass"></div>
        <div class="vignette"></div>
        <div class="glow"></div>
      </div>
    </div>
    <div class="badge">LIMINALÂ·CRT</div>
    <div class="speaker" aria-hidden="true"></div>
    <div class="bar">
      <div class="title" id="tvTitle">&nbsp;</div>
      <button class="btn" id="tvInsert">INSERT</button>
      <button class="btn primary" id="tvPlay">PLAY â–¶</button>
      <button class="btn warn" id="tvClose">EJECT</button>
    </div>
  </div>

  <!-- A11y-only controller to satisfy screen readers & tests -->
  <div id="controller" role="dialog" aria-modal="true" aria-labelledby="prevTitle" hidden>
    <div class="sheet">
      <h3 id="prevTitle">&nbsp;</h3>
      <div id="prevUrl"></div>
      <iframe id="prevFrame" hidden></iframe>
      <button id="btnInsertPlay" type="button">INSERT / TUNE</button>
      <button id="btnInsert"     type="button">INSERT</button>
      <button id="btnOpen"       type="button">TUNE</button>
      <button id="btnClose"      type="button">EJECT</button>
    </div>
  </div>

<script>
/* =============================================================
   THE LIMINAL ARCHIVE â€” VHS Stacks / Ultra VCR (Diegetic UI)
   Now with a floating TV **preview** that looks/behaves like a
   real CRT. All film jitter/glow is **limited to the TV screen**;
   text, VCR chrome, and labels stay crisp.
   ============================================================= */

// ---- Data ---- (All 32 HTML files from manifest)
const ITEMS = [
  {title:"The Liminal Archive (Main)", url:"./index.html"},
  {title:"Index Launcher", url:"./index-launcher.html"},
  {title:"VIDEO_STACKER_PLUS", url:"./vs-plu.html"},
  {title:"VIDEO_STACKER Pro Filmic", url:"./video_stacker_pro_filmic_v_2_100_tv_layouts_calm_mode.html"},
  {title:"VIDEO_STACKER_âˆž (Main)", url:"./video_stacker_âˆž_index.html"},
  {title:"VIDEO_STACKER_âˆž Mobile", url:"./video_stacker_âˆž_mobile_swipe_right_edge_controls_haptics_audio_index.html"},
  {title:"VIDEO_STACKER_âˆž YouTube CSS3D", url:"./video_stacker_âˆž_you_tube_css_3_d_edition.html"},
  {title:"VIDEO_STACKER_âˆž YouTube CSS3D (v2)", url:"./video_stacker_âˆž_you_tube_css_3_d_edition (1).html"},
  {title:"VIDEO_STACKER_âˆž YouTube CSS3D (v3)", url:"./video_stacker_âˆž_you_tube_css_3_d_edition (2).html"},
  {title:"VIDEO_STACKER_âˆž YouTube CSS3D (v4)", url:"./video_stacker_âˆž_you_tube_css_3_d_edition (3).html"},
  {title:"VIDEO_STACKER_âˆž YouTube CSS3D (v5)", url:"./video_stacker_âˆž_you_tube_css_3_d_edition (4).html"},
  {title:"Video Stacker 02", url:"./video-stacker-02.html"},
  {title:"VS Stacker", url:"./vs-stacker.html"},
  {title:"VS STTY", url:"./vs-stty.html"},
  {title:"VSS", url:"./vss.html"},
  {title:"Video 01", url:"./video-01.html"},
  {title:"Video 02", url:"./video-02.html"},
  {title:"Video Refactor", url:"./video-refactor.html"},
  {title:"Video Full", url:"./video_full.html"},
  {title:"CRT Stack", url:"./crt-stack.html"},
  {title:"Eno CRT", url:"./eno-crt.html"},
  {title:"Multi-Mode", url:"./multi-mode.html"},
  {title:"Pyramid Scene", url:"./pyramid-scene.html"},
  {title:"Feed to Water", url:"./feed-to-water.html"},
  {title:"JJ", url:"./jj.html"},
  {title:"HOM", url:"./hom.html"},
  {title:"HUT", url:"./hut.html"},
  {title:"Inicio", url:"./inicio.html"},
  {title:"IVST", url:"./ivst.html"},
  {title:"Prod", url:"./prod.html"},
  {title:"Wreck", url:"./wreck.html"}
];

// Load additional items from manifest.json if available
fetch('./manifest.json').then(r=>r.json()).then(data=>{
  console.log(`ðŸ“š Manifest loaded: ${data.total_items} items available`);
}).catch(()=>{
  console.log('ðŸ“š Using embedded items list');
});

// ---- Canvas / DPR scaling ----
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W=0, H=0;
function scaleCanvas(){
  const dpr = Math.min(window.devicePixelRatio||1, 2);
  const lw = window.innerWidth, lh = window.innerHeight;
  canvas.width = Math.floor(lw*dpr); canvas.height = Math.floor(lh*dpr);
  canvas.style.width = lw+'px'; canvas.style.height = lh+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0); recomputeMetrics();
}
let _rz; window.addEventListener('resize', ()=>{ clearTimeout(_rz); _rz=setTimeout(()=>{ scaleCanvas(); draw(); }, 90); }, {passive:true});

// Noise buffer for film grain
let noiseCanvas, noiseCtx, noiseTime=0;

// ---- Config / State ----
const G = 1650; // gravity
let unit=16, TAPE_W=144, TAPE_H=80, BASE_Y=0; // metrics
let labelScale = 1.0;
let VIEW='SPINE', LAYOUT='STACK', LABEL_SKIN='LOFI';
const PALETTES = [ ['#102018','#0b251b','#e2ffee'], ['#17131d','#241a2e','#efe7ff'], ['#1a0f10','#2a1718','#ffe6ea'], ['#0f171f','#0b1f2a','#e6f5ff'], ['#1a1a12','#232312','#fff9d9'] ];

// Floating TV DOM
const tv = document.getElementById('tv');
const tvFrame = document.getElementById('tvFrame');
const tvTitle = document.getElementById('tvTitle');
const tvInsert = document.getElementById('tvInsert');
const tvPlay = document.getElementById('tvPlay');
const tvClose = document.getElementById('tvClose');

function tvShow(tape){
  tvTitle.textContent = tape.title;
  // Load the live page into the CRT preview â€“ user can see what's in the tape.
  tvFrame.src = tape.url;
  tv.classList.add('show');
}
function tvHide(){ tv.classList.remove('show'); tvFrame.removeAttribute('src'); }
function tvPlayNow(url){ window.open(url, '_blank'); }

function vcrMetrics(){
  const x=W/2, y=H - unit*8.6, w=unit*30, h=unit*8.2; // taller deck
  const screen = { x:x-w*0.34, y:y-h*0.18, w:w*0.42, h:h*0.38 };
  const timeLCD = { x:x+w*0.20, y:y-h*0.26, w:w*0.24, h:h*0.12 };
  const btnRowY = y + h*0.18;
  const btnW = unit*1.8, btnH = unit*1.0;
  const btns = {
    play:  {x:x+w*0.06, y:btnRowY, w:btnW, h:btnH, label:'PLAY'},
    stop:  {x:x+w*0.20, y:btnRowY, w:btnW, h:btnH, label:'STOP'},
    eject: {x:x+w*0.34, y:btnRowY, w:btnW, h:btnH, label:'EJECT'}
  };
  const slotCX=x, slotCY=y + 0.02*h;
  return {x,y,w,h,screen,timeLCD,btns,slotCX,slotCY};
}

let fx = { coldOpen:true, since:0, ghostAlpha:0, ghostText:'', weavePhase:0, timeBase:0, headSwitch:0, chromaShift:0, noiseAlpha:0.12, reduceMotion:window.matchMedia('(prefers-reduced-motion: reduce)').matches };
let COLS=[]; let falling=null; let wobble=0; let ingress=null; let queue = ITEMS.map((it,i)=>({...it,themeIndex:i%PALETTES.length}));
let preview=null; // {colIndex,tapeIndex,title,url}
let vcrUI = { active:false, regions:{} };

// Helpers
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t; const easeInCubic=t=>t*t*t; const easeBack=(t)=>{const c1=1.70158; const c3=c1+1; return 1 + c3*Math.pow(t-1,3) + c1*Math.pow(t-1,2);} 
function openItem(url){ const id=/^[A-Za-z0-9_-]{11}$/.test(url); window.open(id?`https://www.youtube.com/watch?v=${url}`:url,'_blank'); }

// A11y dialog handles (kept, but tv overlay is primary)
const ctrl = document.getElementById('controller');
const prevFrame = document.getElementById('prevFrame');
const prevTitle = document.getElementById('prevTitle');
const prevUrl = document.getElementById('prevUrl');
const btnInsertPlay = document.getElementById('btnInsertPlay');
const btnInsert = document.getElementById('btnInsert');
const btnOpen = document.getElementById('btnOpen');
const btnClose = document.getElementById('btnClose');
let lastFocus=null;

function showController(tape){
  preview = tape; vcrUI.active = true; lastFocus=document.activeElement;
  prevTitle.textContent=tape.title; prevUrl.textContent=tape.url; prevFrame.src=tape.url; // a11y only
  tvShow(tape);
}
function hideController(){ vcrUI.active=false; preview=null; if(lastFocus) lastFocus.focus(); tvHide(); }
btnInsertPlay.onclick = ()=>{ if(!preview) return; startIngress(preview,true); };
btnInsert.onclick     = ()=>{ if(!preview) return; startIngress(preview,false); };
btnOpen.onclick       = ()=>{ if(!preview) return; openItem(preview.url); };
btnClose.onclick      = ()=>{ hideController(); };

// TV overlay button hooks
tvInsert.onclick = ()=>{ if(!preview) return; startIngress(preview,false); };
 tvPlay.onclick  = ()=>{ if(!preview) return; tvPlayNow(preview.url); };
 tvClose.onclick = ()=>{ hideController(); };

// Metrics / columns
function proposeUnitForCount(count){ let u=Math.max(12, Math.min(24, Math.floor(W/42))); for(let i=0;i<3;i++){ const rows=Math.ceil(count/computeNumCols()); const tapeH=u*5.2; const baseY=H - u*13.8; const avail=baseY - u*2; const need=rows*(tapeH+6); if(need>avail) u=Math.max(9,u*(avail/need)); } return u; }
function computeNumCols(){ const byW=W>=980?3:(W>=600?2:1); const byN=queue.length + COLS.reduce((s,c)=>s+c.stack.length,0) > 20 ? Math.max(2,byW) : byW; return Math.min(3, Math.max(1,byN)); }
function applyUnit(u){ unit=u; TAPE_W=unit*9; TAPE_H=unit*5.2; BASE_Y=H - unit*13.8; buildNoise(); }
function layoutColumns(){ const n=computeNumCols(); const centers=[]; if(n===1) centers.push(W/2); if(n===2) centers.push(W*0.32,W*0.68); if(n===3) centers.push(W*0.22,W*0.5,W*0.78); const old=COLS; COLS=[]; for(let i=0;i<n;i++) COLS.push({id:i,x:centers[i],stack:[]}); if(old&&old.length){ for(const col of old){ const target=COLS.reduce((b,c)=>Math.abs(c.x-col.x)<Math.abs(b.x-col.x)?c:b,COLS[0]); for(const t of col.stack){ target.stack.push({...t}); } } } reflowStacks(); }
function recomputeMetrics(){ W=innerWidth; H=innerHeight; applyUnit(proposeUnitForCount(queue.length + (COLS.reduce((s,c)=>s+c.stack.length,0)) + (falling?1:0))); layoutColumns(); }
function reflowStacks(){ for(const col of COLS){ for(let i=0;i<col.stack.length;i++){ col.stack[i].x=col.x; col.stack[i].y=BASE_Y - TAPE_H/2 - i*(TAPE_H+6); } } if(falling) falling=null; }
scaleCanvas();

// Spawning
function shortestColumn(){ return COLS.slice().sort((a,b)=>a.stack.length-b.stack.length)[0]; }
function nextTape(){ if(!queue.length || falling || ingress || VIEW!=='SPINE' || LAYOUT!=='STACK') return; const col=shortestColumn(); const item=queue.shift(); falling={ col:col.id, x:col.x, y: -TAPE_H*1.2, vx:0, vy:0, title:item.title, url:item.url, themeIndex:item.themeIndex }; }

// Input
canvas.addEventListener('click', e=>{
  const x=e.clientX, y=e.clientY;
  if(vcrUI.active){ const r=vcrUI.regions; if(r){ if(pointInRect(x,y,r.screen)){ if(preview) openItem(preview.url); return; }
      if(pointInRect(x,y,r.play)){ if(preview) { startIngress(preview,true); } return; }
      if(pointInRect(x,y,r.stop)){ hideController(); return; }
      if(pointInRect(x,y,r.eject)){ hideController(); return; }
  } }
  const hit = hitTest(x,y); if(hit){ showController(hit); }
});
function pointInRect(x,y,rect){ return rect && x>rect.x-rect.w/2 && x<rect.x+rect.w/2 && y>rect.y-rect.h/2 && y<rect.y+rect.h/2; }

// gesture toggles
let lastTap=0; const touches=new Map();
canvas.addEventListener('pointerdown', e=>{ touches.set(e.pointerId,{x:e.clientX,y:e.clientY,time:performance.now()}); canvas.setPointerCapture(e.pointerId); });
canvas.addEventListener('pointerup', e=>{ const now=performance.now(); const prev=lastTap; lastTap=now; const dt=now-prev; const two=touches.size>=2; touches.delete(e.pointerId); if(dt<280){ if(two){ if(VIEW==='SPINE'){ LAYOUT = (LAYOUT==='STACK')?'SHELF':'STACK'; ensureAllSpawnedIfNeeded(); reflowStacks(); } } else { VIEW = (VIEW==='SPINE')?'FACE':'SPINE'; ensureAllSpawnedIfNeeded(); } } });
window.addEventListener('keydown', e=>{ if(e.key==='v'){ VIEW=(VIEW==='SPINE')?'FACE':'SPINE'; ensureAllSpawnedIfNeeded(); } if(e.key==='l'&&VIEW==='SPINE'){ LAYOUT=(LAYOUT==='STACK')?'SHELF':'STACK'; ensureAllSpawnedIfNeeded(); reflowStacks(); } if(e.key==='s'){ LABEL_SKIN=(LABEL_SKIN==='LOFI')?'RAINBOW90':'LOFI'; } });
function ensureAllSpawnedIfNeeded(){ if(VIEW!=='SPINE'||LAYOUT!=='STACK'){ while(queue.length){ const col=shortestColumn(); const it=queue.shift(); col.stack.push({x:col.x,y:BASE_Y - TAPE_H/2 - col.stack.length*(TAPE_H+6), title:it.title,url:it.url,themeIndex:it.themeIndex}); } } }

// pinch label size
canvas.addEventListener('wheel', e=>{ labelScale = clamp(labelScale + (e.deltaY>0?-0.05:0.05), 0.6, 2.0); draw(); }, {passive:true});

// Loop
let last=performance.now(); function loop(ts){ const dt=Math.min(0.033,(ts-last)/1000); last=ts; update(dt); draw(); requestAnimationFrame(loop);} requestAnimationFrame(loop);

function update(dt){
  noiseTime += dt; if (fx.coldOpen){ fx.since+=dt; if(fx.since>1.8){ fx.coldOpen=false; fx.since=0; } }
  // We keep internal physics clean; no global weave/timebase errors.
  if(!falling) nextTape();
  if(VIEW==='SPINE' && LAYOUT==='STACK' && falling){ falling.vy+=G*dt; falling.y+=falling.vy*dt; const col=COLS[falling.col]; const surface=baseYForNext(col); if(falling.y + TAPE_H/2 >= surface){ falling.y = surface - TAPE_H/2; col.stack.push({x:col.x,y:falling.y,title:falling.title,url:falling.url,themeIndex:falling.themeIndex}); falling=null; applyUnit(proposeUnitForCount(queue.length + COLS.reduce((s,c)=>s+c.stack.length,0))); reflowStacks(); staticBurst(); } }
}

function startIngress(sel, goAfter){ const col=COLS[sel.colIndex]; const t=flattenStacks()[sel.tapeIndex] || (col?col.stack[sel.tapeIndex]:null); if(!t) return; t.hidden=true; const v=vcrMetrics(); ingress={ x:t.x||W/2, y:t.y||H/2, sx:t.x||W/2, sy:t.y||H/2, tx:v.slotCX, ty:v.slotCY, t0:performance.now(), dur:760, title:t.title, url:t.url, themeIndex:t.themeIndex }; setTimeout(()=>{ if(goAfter) openItem(t.url); }, 780); }
function baseYForNext(col){ return col.stack.length? col.stack[col.stack.length-1].y - TAPE_H - 6 : BASE_Y; }

// Render
function draw(){ ctx.clearRect(0,0,W,H); drawBackdrop(); if(VIEW==='SPINE'){ if(LAYOUT==='STACK'){ for(const col of COLS){ for(const t of col.stack){ if(!t.hidden) drawSpineTape(t.x,t.y,t.title,false,t.themeIndex); } } if(falling) drawSpineTape(falling.x, falling.y, falling.title, true, falling.themeIndex); if(ingress) drawSpineTape(ingress.x, ingress.y, ingress.title, true, ingress.themeIndex); drawVCR(); } else { const all=flattenStacks(); const rows=W>=900?3:(W>=600?2:1); const perRow=Math.ceil(all.length/rows); const gap=Math.max(8,unit*0.8); const w=TAPE_H, h=TAPE_W; for(let r=0;r<rows;r++){ for(let i=0;i<perRow;i++){ const idx=r*perRow+i; if(idx>=all.length) break; const t=all[idx]; const x=(W - (perRow*(w+gap)-gap))/2 + i*(w+gap) + w/2; const y=BASE_Y - r*(h+gap) - h/2; drawSpineTape(x,y,t.title,false,t.themeIndex,true); } } } } else if(VIEW==='FACE'){ const grid=faceGrid(); for(const cell of grid){ const {cx,cy,w,h,idx}=cell; const t=flattenStacks()[idx]; if(t) drawFaceCassette(cx,cy,w,h,t.title,t.themeIndex); } }
  // No global film FX here; labels & UI remain crisp.
  if(noiseCanvas){ ctx.globalAlpha = .06; ctx.drawImage(noiseCanvas,0,0,W,H); ctx.globalAlpha=1; }
}

function faceGrid(){ const all=flattenStacks(); const cols=W>=980?4:(W>=720?3:(W>=520?2:1)); const gap=Math.max(12,unit*0.9); const w=Math.min(280,(W-gap*(cols+1))/cols); const h=w*0.56*1.25; const rows=Math.ceil(all.length/cols); const top=Math.max(40,H-(rows*(h+gap)+120)); const cells=[]; for(let r=0;r<rows;r++){ for(let c=0;c<cols;c++){ const idx=r*cols+c; if(idx>=all.length) break; const cx=gap+w/2+c*(w+gap); const cy=top+h/2+r*(h+gap); cells.push({cx,cy,w,h,idx}); } } return cells; }
function flattenStacks(){ const out=[]; for(const col of COLS){ for(const t of col.stack){ out.push(t); } } if(out.length===0){ return ITEMS.map((it,i)=>({title:it.title,url:it.url,themeIndex:i%PALETTES.length})); } return out; }

function drawBackdrop(){ const g=ctx.createRadialGradient(W/2,H*0.2,12,W/2,H*0.2,Math.max(W,H)); g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.62)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); const lg=ctx.createLinearGradient(0,0,W,H); lg.addColorStop(0,'rgba(16,24,18,.15)'); lg.addColorStop(1,'rgba(10,12,16,.05)'); ctx.fillStyle=lg; ctx.fillRect(0,0,W,H); }

function drawVCR(){ const m=vcrMetrics(); const {x,y,w,h} = m; // body
  roundRect(x-w/2, y-h/2, w, h, 14, '#0b0f13', '#121820'); // face
  roundRect(x-w*0.36, y-h*0.02, w*0.72, h*0.18, 8, '#0b0f14', '#0e141a');
  const s=m.screen; roundRect(s.x, s.y, s.w, s.h, 6, '#050607', '#0c0f12');
  // little play glyph frozen on VCR screen (no jitter)
  ctx.save(); ctx.beginPath(); ctx.rect(s.x, s.y, s.w, s.h); ctx.clip();
  const pSize=Math.min(s.h*0.45, s.w*0.45); ctx.fillStyle='rgba(255,255,255,.86)'; ctx.beginPath(); ctx.moveTo(s.x+s.w/2-pSize*0.28, s.y+s.h/2-pSize*0.34); ctx.lineTo(s.x+s.w/2+pSize*0.42, s.y+s.h/2); ctx.lineTo(s.x+s.w/2-pSize*0.28, s.y+s.h/2+pSize*0.34); ctx.closePath(); ctx.fill(); ctx.restore();
  // label below screen
  ctx.fillStyle='rgba(233,239,231,.9)'; ctx.font=`${Math.floor(unit*0.8)}px Inter, system-ui`; ctx.textAlign='left'; ctx.textBaseline='top'; const label=preview?preview.title: 'â€”'; ctx.fillText(label, s.x, s.y+s.h+6, s.w);
  // compact clock
  const t=m.timeLCD; roundRect(t.x, t.y, t.w, t.h, 4, 'rgba(9,12,13,.95)', 'rgba(18,26,28,.95)'); drawSevenSeg(t.x+t.w*0.08, t.y+t.h*0.5, Math.min(unit*1.6, t.h*0.7), '12:00');
  // buttons
  for(const key of ['play','stop','eject']){ const b=m.btns[key]; drawButton(b.x, b.y, b.w, b.h, b.label); }
  vcrUI.regions = { screen:{x:s.x+s.w/2, y:s.y+s.h/2, w:s.w, h:s.h}, play:m.btns.play, stop:m.btns.stop, eject:m.btns.eject };
}

function drawSevenSeg(cx,cy,size,text){ ctx.save(); ctx.translate(cx,cy); ctx.fillStyle='#21ff86'; ctx.globalAlpha=0.92; ctx.font=`${Math.floor(size)}px ui-monospace,monospace`; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillText(text, 0, 0); ctx.globalAlpha=1; ctx.restore(); }
function drawButton(cx,cy,w,h,label){ roundRect(cx-w/2, cy-h/2, w, h, 6, '#0e1419', '#0c1015'); ctx.fillStyle='rgba(255,255,255,.92)'; ctx.font=`${Math.floor(h*0.38)}px Inter,system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(label, cx, cy); }

// SPINE view tape
function drawSpineTape(x,y,title,live=false,themeIndex=0,upright=false){ ctx.save(); ctx.translate(x,y); if(upright) ctx.rotate(-Math.PI/2); const w=TAPE_W, h=TAPE_H; const pad=8; const pal=PALETTES[themeIndex % PALETTES.length]; ctx.fillStyle='rgba(0,0,0,.38)'; ctx.fillRect(-w/2-12, h/2-2, w+24, 12); roundRect(-w/2,-h/2,w,h,8,'#0e1319','#121921'); roundRect(-w/2+pad,-h/2+pad,w-2*pad,h-2*pad,6,pal[0],pal[1]); ctx.globalAlpha=0.12; ctx.fillStyle='#fff'; ctx.fillRect(-w/2+6,-h/2+6,w-12,2); ctx.fillRect(-w/2+6, h/2-8, w-12, 2); ctx.globalAlpha=1; if(LABEL_SKIN==='RAINBOW90') drawRainbowSticker(-w*0.36,-h*0.40,w*0.72,h*0.52); else roundRect(-w*0.36,-h*0.40,w*0.72,h*0.52,6,pal[0],pal[1]); const rr=Math.min(h*0.18, w*0.12); drawReel(-w*0.25,0,rr); drawReel(w*0.25,0,rr); const base=h*0.20*labelScale; const txt=title.toUpperCase(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`${Math.floor(base)}px VT323, ui-monospace, monospace`; ctx.fillStyle='#e9efe7'; ctx.fillText(txt,0,-h*0.06); if(live){ ctx.globalAlpha=0.9; ctx.fillStyle='#21ff86'; ctx.fillRect(w*0.34, -h*0.48, 6, h*0.96); ctx.globalAlpha=1; } ctx.restore(); }
function drawRainbowSticker(x,y,w,h){ const r=6; roundRect(x,y,w,h,r,'#f6efe0','#efe7d6'); const stripes=['#ff3b58','#ff6a2a','#ffb300','#ffdd3a','#6ee45a','#34c8ff','#a86dff']; const d=h*0.55; for(let i=0;i<stripes.length;i++){ ctx.fillStyle=stripes[i]; ctx.beginPath(); ctx.moveTo(x, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h - (i+1)*(d/stripes.length)); ctx.lineTo(x, y+h - i*(d/stripes.length)); ctx.closePath(); ctx.fill(); } }

// FACE view product
function drawFaceCassette(cx,cy,w,h,title){ ctx.save(); ctx.translate(cx,cy); roundRect(-w/2,-h/2,w,h,14,'#101418','#0c0f13'); roundRect(-w*0.28,-h*0.10,w*0.56,h*0.22,8,'#f7f1e6','#efe7d6'); roundRect(-w*0.40,-h*0.34,w*0.80,h*0.10,6,'#f7f1e6','#efe7d6'); drawWindow(-w*0.32,-h*0.06,w*0.22,h*0.26); drawWindow(w*0.32-w*0.22,-h*0.06,w*0.22,h*0.26); const r=Math.min(h*0.16,w*0.12); drawReel(-w*0.23,0,r); drawReel(w*0.23,0,r); ctx.fillStyle='#111'; ctx.font=`${Math.floor(h*0.09)}px Inter, system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(title,0,-h*0.01); if(LABEL_SKIN==='RAINBOW90'){ const sx=-w*0.40, sy=h*0.12, sw=w*0.80, sh=h*0.12; ctx.save(); ctx.translate(sx,sy); ctx.beginPath(); ctx.rect(0,0,sw,sh); ctx.clip(); const stripes=['#ff3b58','#ff6a2a','#ffb300','#ffdd3a','#6ee45a','#34c8ff','#a86dff']; for(let i=-2;i<12;i++){ ctx.fillStyle=stripes[(i+stripes.length)%stripes.length]; ctx.fillRect(i*sw/10, sh*0.2, sw/10, sh); } ctx.restore(); } ctx.restore(); }
function drawWindow(x,y,w,h){ roundRect(x,y,w,h,6,'#0b0f12','#0f151b'); ctx.globalAlpha=0.3; roundRect(x,y,w,h,6,'#1a2730','#0a1016'); ctx.globalAlpha=1; }
function drawReel(cx,cy,r){ ctx.save(); ctx.translate(cx,cy); circle(0,0,r,'#0b0f13'); circle(0,0,r*0.66,'#111821'); ctx.globalAlpha=0.35; for(let i=0;i<6;i++){ roundRect(-2,-r*0.52,4,r*0.22,2,'#dfe','#cfe'); ctx.rotate(Math.PI/3); } ctx.globalAlpha=1; ctx.restore(); }
function roundRect(x,y,w,h,r,c1,c2){ const grad=ctx.createLinearGradient(x,y,x+w,y+h); grad.addColorStop(0,c1); grad.addColorStop(1,c2); ctx.fillStyle=grad; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill(); }
function circle(x,y,r,col){ ctx.beginPath(); ctx.fillStyle=col; ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }

// Noise
function buildNoise(){ noiseCanvas=document.createElement('canvas'); noiseCanvas.width=Math.max(64,Math.floor(W/2)); noiseCanvas.height=Math.max(64,Math.floor(H/2)); noiseCtx=noiseCanvas.getContext('2d'); const img=noiseCtx.createImageData(noiseCanvas.width,noiseCanvas.height); const data=img.data; for(let i=0;i<data.length;i+=4){ const v=(Math.random()*255)|0; data[i]=v; data[i+1]=v; data[i+2]=v; data[i+3]=35; } noiseCtx.putImageData(img,0,0); }
function staticBurst(){ if(!noiseCtx) return; const img=noiseCtx.getImageData(0,0,noiseCanvas.width,noiseCanvas.height); const data=img.data; for(let i=0;i<data.length;i+=4){ if(Math.random()<0.12){ const v=255; data[i]=v; data[i+1]=v; data[i+2]=v; data[i+3]=120; } } noiseCtx.putImageData(img,0,0); setTimeout(buildNoise,60); }

// (No drawFilmFX) â€” effects are DOM-based inside #tv only.

// Hitâ€‘testing for tapes
function hitTest(x,y){ if(VIEW==='FACE'){ const grid=faceGrid(); for(const cell of grid){ const {cx,cy,w,h,idx}=cell; if(x>cx-w/2 && x<cx+w/2 && y>cy-h/2 && y<cy+h/2){ const t=flattenStacks()[idx]; if(t) return {colIndex:0,tapeIndex:idx,title:t.title,url:t.url}; } } return null; } for(const [ci,col] of COLS.entries()){ for(let i=col.stack.length-1;i>=0;i--){ const t=col.stack[i]; if(LAYOUT==='STACK'){ if(!t.hidden && x>t.x-TAPE_W/2 && x<t.x+TAPE_W/2 && y>t.y-TAPE_H/2 && y<t.y+TAPE_H/2) return {colIndex:ci,tapeIndex:i,title:t.title,url:t.url}; } else { const w=TAPE_H,h=TAPE_W; const rx=t.x - w/2, ry=t.y - h/2; if(x>rx&&x<rx+w&&y>ry&&y<ry+h) return {colIndex:ci,tapeIndex:i,title:t.title,url:t.url}; } } } return null; }

// Tests (kept + TV overlay assertions)
(function(){ const out=[]; try{ out.push(unit>0 && TAPE_W>0 && TAPE_H>0 ? 'PASS metrics' : 'FAIL metrics'); const ncols=computeNumCols(); out.push(ncols>=1 && ncols<=3? 'PASS cols': 'FAIL cols'); const dummy={x:W/2, stack:[]}; const b0=baseYForNext(dummy); dummy.stack.push({y:BASE_Y - TAPE_H/2}); const b1=baseYForNext(dummy); const step=(BASE_Y - TAPE_H - 6); out.push(Math.abs(b1-step)<0.001? 'PASS baseY step':'FAIL baseY step'); out.push(['SPINE','FACE'].includes(VIEW)? 'PASS view':'FAIL view'); out.push(['STACK','SHELF'].includes(LAYOUT)? 'PASS layout':'FAIL layout'); out.push(['LOFI','RAINBOW90'].includes(LABEL_SKIN)? 'PASS skin':'FAIL skin'); out.push(document.getElementById('controller').getAttribute('role')==='dialog' ? 'PASS a11y dialog' : 'FAIL a11y dialog'); const m=vcrMetrics(); out.push((m.screen&&m.btns&&m.timeLCD)? 'PASS vcr regions':'FAIL vcr regions'); out.push(document.getElementById('tv')? 'PASS tv exists':'FAIL tv exists'); out.push(document.getElementById('tvPlay')? 'PASS tv controls':'FAIL tv controls'); }catch(e){ out.push('FAIL harness: '+e.message); } console.log('[tests]', out.join(' | ')); })();

</script>
</body>
</html>
