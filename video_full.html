<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>VIDEO_STACKER_âˆž â€” YouTube Edition</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root { --ui:#0f0; --bg:#000; --hud:#0a0a0a; --glow: rgba(0,255,0,0.35); }
html, body { height:100%; }
body {
  font-family:'Courier New', monospace; background:var(--bg); overflow:hidden; touch-action: pan-y; -webkit-user-select:none; user-select:none;
}
/* Stacked renderers */
#stage { position:fixed; inset:0; overflow:hidden; }
#webgl, #css3d { position:absolute; inset:0; touch-action:none; pointer-events:none; }
#hud {
  position:fixed; top: env(safe-area-inset-top, 16px); left: env(safe-area-inset-left, 14px);
  color:var(--ui); font-size:13px; z-index:20; text-shadow:0 0 8px #000; line-height:1.6;
  background: rgba(0,0,0,.25); border:1px solid var(--ui); padding:10px 12px; border-radius:10px; backdrop-filter: blur(4px);
}
#score { font-size:26px; font-weight:700; letter-spacing:2px; }
#stability-bar { width:120px; height:6px; background:#111; margin:6px 0; border:1px solid var(--ui); position:relative; box-shadow:0 0 10px var(--glow); }
#stability-fill { height:100%; background: linear-gradient(90deg, #f33, #ff0, #0f0); transition:width .2s; }
#controls { position:fixed; right: env(safe-area-inset-right, 10px); top:50%; transform: translateY(-50%); display:flex; flex-direction:column; gap:12px; z-index:30; }
.control-btn {
  width:54px; height:54px; border-radius:50%; border:2px solid var(--ui); background: rgba(10,10,10,.85); color:var(--ui);
  font-weight:700; font-size:18px; display:flex; align-items:center; justify-content:center; cursor:pointer; touch-action:manipulation;
  transition: transform .12s, background .12s, color .12s, box-shadow .12s; box-shadow:0 0 12px var(--glow);
}
.control-btn:active { transform: scale(.92); background:var(--ui); color:#000; box-shadow:0 0 18px rgba(0,255,0,.6); }
.control-btn.small { width:46px; height:46px; font-size:14px; }
.row { display:flex; gap:10px; }
#dock { position:fixed; left:50%; transform:translateX(-50%); bottom: env(safe-area-inset-bottom, 14px); display:flex; gap:10px; z-index:25; }
.dock-btn { padding:10px 14px; border:2px solid var(--ui); color:var(--ui); background: rgba(0,0,0,.7); border-radius:12px; font-weight:700; font-size:12px; letter-spacing:.5px; box-shadow:0 0 10px var(--glow); cursor:pointer; touch-action:manipulation; }
.dock-btn:active { background:var(--ui); color:#000; }
#playlist { position: fixed; right: env(safe-area-inset-right, 10px); bottom: calc(env(safe-area-inset-bottom, 10px) + 70px); width: 54px; z-index: 30; }
#playlist .panel { display:none; position:absolute; right:60px; bottom:0; width:260px; background: rgba(0,0,0,.9); border:2px solid var(--ui); border-radius:12px; padding:12px; box-shadow:0 0 16px var(--glow); }
#playlist .panel textarea { width:100%; height:120px; background:#060; color:#cfc; border:1px solid #0a0; font-family:inherit; font-size:12px; padding:6px; }
#playlist .panel .row { margin-top:8px; justify-content:space-between; }
#playlist-toggle { width:54px; height:54px; }
#swipe-hint { position:fixed; bottom: calc(env(safe-area-inset-bottom, 80px) + 60px); left:50%; transform:translateX(-50%); color:var(--ui); font-size:14px; text-shadow:0 0 8px #000; opacity:.75; z-index:15; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:.75} 50%{opacity:.35} }
#game-over { position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:40; }
#game-over .box { background: rgba(0,0,0,.95); border:4px solid var(--ui); color:var(--ui); padding:28px 22px; width:min(92vw, 420px); text-align:center; box-shadow:0 0 30px var(--glow); border-radius:14px; }
#game-over h1 { font-size:28px; letter-spacing:3px; margin-bottom:12px; }
#game-over button { margin-top:18px; padding:12px 28px; border:2px solid var(--ui); background:#0a0a0a; color:var(--ui); font-weight:700; font-family:inherit; cursor:pointer; }
#loading { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; color:var(--ui); font-size:18px; z-index:100; background: radial-gradient( circle at 50% 50%, rgba(0,255,0,.07), rgba(0,0,0,.95) 60% ); text-shadow:0 0 8px #000; }
.badge { position:fixed; right:10px; top:10px; z-index:5; color:#0b0; font-size:11px; opacity:.6; }
</style>
</head>
<body>
<div id="loading">LOADING VIDEO_STACKER_âˆž â€¦</div>
<div class="badge">YT+CSS3D+Physics</div>

<div id="stage">
  <div id="webgl"></div>
  <div id="css3d"></div>
</div>

<!-- HUD -->
<div id="hud">
  <div id="score">0</div>
  <div>H: <span id="height">0.0</span>m</div>
  <div>Ã—<span id="streak">0</span></div>
  <div id="stability-bar"><div id="stability-fill" style="width:100%"></div></div>
  <div style="font-size:10px; opacity:.7">HI: <span id="high-score">0</span></div>
</div>

<!-- Floating controls -->
<div id="controls">
  <button class="control-btn small" id="btn-view" title="Change View">âŸ²</button>
  <button class="control-btn small" id="btn-cull" title="Remove Bottom">âœ•</button>
  <button class="control-btn small" id="btn-mute" title="Mute">ðŸ”Š</button>
  <button class="control-btn" id="btn-drop" title="Drop Now">â†“</button>
</div>

<!-- Dock -->
<div id="dock">
  <button class="dock-btn" id="btn-autofall">AUTOFALL: OFF</button>
  <button class="dock-btn" id="btn-mode">MODE: HYBRID</button>
</div>

<!-- Playlist editor -->
<div id="playlist">
  <button class="control-btn" id="playlist-toggle" title="Playlist">â–¶ï¸Ž</button>
  <div class="panel" id="playlist-panel">
    <div style="color:#9f9; font-size:12px; margin-bottom:6px;">Paste YouTube IDs (one per line)</div>
    <textarea id="playlist-input"></textarea>
    <div class="row">
      <button class="dock-btn" id="playlist-apply">Apply</button>
      <button class="dock-btn" id="playlist-shuffle">Shuffle</button>
      <button class="dock-btn" id="playlist-close">Close</button>
    </div>
  </div>
</div>

<div id="swipe-hint">â†‘ SWIPE UP TO DROP â†‘</div>

<!-- Game Over -->
<div id="game-over">
  <div class="box">
    <h1>COLLAPSE</h1>
    <div id="final-score"></div>
    <button id="btn-restart">RESTART</button>
  </div>
</div>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS3DRenderer.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
/* ========= Config ========= */
const TV = { w: 0.60, d: 0.45, h: 0.40 };
const SCREEN = { w: TV.w * 0.84, h: TV.h * 0.68 };
const GAP_Y = 0.05;
const PHYS_LIMIT = 0.22;
const STAB_ALPHA = 0.7;
const SHARD_COUNT = 48;
const SHARD_TTL = 2800;
const AUTOFALL_INTERVAL = 2200; // ms
const TOP_N_LIVE = 6; // only top N iframes actively play (perf on mobile)
const CAMERA_PRESETS = [
  { pos:[0, 2.0, 4.4], look:[0, 1.0, 0] },
  { pos:[-2.4, 2.6, 3.3], look:[0, 1.1, 0] },
  { pos:[2.4, 2.6, 3.3], look:[0, 1.1, 0] },
  { pos:[0.0, 1.0, 3.8], look:[0, 1.2, 0] },
  { pos:[0.0, 5.6, 0.2], look:[0, 0.2, 0] }
];

const MODES = ["HYBRID","GAME","GALLERY"];
let MODE = 0; // 0 hybrid, 1 game, 2 gallery

/* ======== State ======== */
let scene, cssScene, camera, renderer, cssRenderer, world, clock;
let tvs = []; // { group, body, cssPivot, cssObj, iframeEl, yt, settled }
let falling = null;
let score = 0, height = 0, streak = 0;
let highScore = parseInt(localStorage.getItem('tv_stacker_high') || '0');
let stability = 1, gameOver = false, muted = false, camPreset = 0;
let isSwiping = false, touchStartY = 0, touchStartX = 0;
let audioCtx, sounds = {};
let autofallOn = false, autofallTimer = null;
let youTubeReady = false;
let playlist = [
  "M7lc1UVf-VE","dQw4w9WgXcQ","kXYiU_JCYtU","e-ORhEE9VVg","hT_nvWreIhg",
  "3JZ4pnNtyxQ","60ItHLz5WEA","fLexgOxsZu0","09R8_2nJtjg","JGwWNGJdvx8"
];
let feedIndex = 0;

function onYouTubeIframeAPIReady(){ youTubeReady = true; }

function haptic(style='light'){
  if (!('vibrate' in navigator)) return;
  const p={ light:10, medium:20, heavy:35, success:[10,40,10], error:[30,80,30,80,30]};
  navigator.vibrate(p[style]||10);
}

function initAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const mk=(f0,f1,d,g=.25)=>()=>{const o=audioCtx.createOscillator(),g1=audioCtx.createGain();o.connect(g1);g1.connect(audioCtx.destination);o.frequency.setValueAtTime(f0,audioCtx.currentTime);o.frequency.exponentialRampToValueAtTime(Math.max(1,f1),audioCtx.currentTime+d);g1.gain.setValueAtTime(g,audioCtx.currentTime);g1.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+d);o.start();o.stop(audioCtx.currentTime+d);};
  sounds.drop=mk(220,120,.25,.28); sounds.land=mk(160,90,.12,.20); sounds.nudge=mk(320,280,.08,.12); sounds.collapse=mk(220,40,.9,.35);
}
function playSound(n){ if(!muted && sounds[n] && audioCtx){ try{sounds[n]();}catch(e){} } }

function setCameraPreset(i){ camPreset=(i+CAMERA_PRESETS.length)%CAMERA_PRESETS.length; const p=CAMERA_PRESETS[camPreset]; camera.position.set(...p.pos); camera.lookAt(new THREE.Vector3(...p.look)); }
function updateHUD(){ document.getElementById('score').textContent=String(score); document.getElementById('height').textContent=height.toFixed(1); document.getElementById('streak').textContent=String(streak); document.getElementById('high-score').textContent=String(highScore); document.getElementById('stability-fill').style.width=(stability*100)+'%'; }

function init(){
  document.getElementById('loading').style.display='none';
  clock=new THREE.Clock();
  scene=new THREE.Scene(); cssScene=new THREE.Scene(); scene.background=new THREE.Color(0x0a0a0a); scene.fog=new THREE.Fog(0x0a0a0a,5,16);
  camera=new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.08, 100); setCameraPreset(0);
  renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setPixelRatio(Math.min(window.devicePixelRatio,1.5)); renderer.setSize(window.innerWidth,window.innerHeight); renderer.shadowMap.enabled=true; document.getElementById('webgl').appendChild(renderer.domElement);
  cssRenderer=new THREE.CSS3DRenderer(); cssRenderer.setSize(window.innerWidth,window.innerHeight); document.getElementById('css3d').appendChild(cssRenderer.domElement); cssRenderer.domElement.style.pointerEvents='none';
  const amb=new THREE.AmbientLight(0x404040,1); scene.add(amb); const key=new THREE.DirectionalLight(0xffffff,.9); key.position.set(3,6,4); key.castShadow=true; const s=6; key.shadow.camera.left=-s; key.shadow.camera.right=s; key.shadow.camera.top=s; key.shadow.camera.bottom=-s; scene.add(key); const fill=new THREE.DirectionalLight(0x80a0ff,.35); fill.position.set(-3,2,-2); scene.add(fill);
  world=new CANNON.World(); world.gravity.set(0,-9.8,0); world.broadphase=new CANNON.SAPBroadphase(world); world.allowSleep=true; world.defaultContactMaterial.friction=.6; world.defaultContactMaterial.restitution=.05;
  const floorShape=new CANNON.Plane(); const floorBody=new CANNON.Body({mass:0,shape:floorShape}); floorBody.quaternion.setFromEuler(-Math.PI/2,0,0); world.addBody(floorBody);
  const floorGeo=new THREE.PlaneGeometry(20,20); const floorMat=new THREE.MeshStandardMaterial({color:0x0d0d0d,roughness:.9}); const floor=new THREE.Mesh(floorGeo,floorMat); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);
  const grid=new THREE.GridHelper(10,22,0x00ff00,0x002200); grid.position.y=0.01; scene.add(grid);
  window.addEventListener('resize', onResize);
  const stage=document.getElementById('stage'); stage.addEventListener('touchstart', onTouchStart, {passive:false}); stage.addEventListener('touchmove', onTouchMove, {passive:false}); stage.addEventListener('touchend', onTouchEnd, {passive:false}); stage.addEventListener('mousedown', firstInteractOnce, {once:true}); stage.addEventListener('touchstart', firstInteractOnce, {once:true});
  document.getElementById('btn-cull').addEventListener('click', cullBottom);
  document.getElementById('btn-view').addEventListener('click', ()=>{ setCameraPreset(camPreset+1); haptic('light'); });
  document.getElementById('btn-mute').addEventListener('click', toggleMute);
  document.getElementById('btn-restart').addEventListener('click', restart);
  document.getElementById('btn-drop').addEventListener('click', dropTV);
  document.getElementById('btn-mode').addEventListener('click', cycleMode);
  document.getElementById('btn-autofall').addEventListener('click', toggleAutofall);
  const panel=document.getElementById('playlist-panel'); const toggle=document.getElementById('playlist-toggle'); const input=document.getElementById('playlist-input'); const apply=document.getElementById('playlist-apply'); const shuffle=document.getElementById('playlist-shuffle'); const close=document.getElementById('playlist-close');
  toggle.addEventListener('click', ()=>{ panel.style.display = (panel.style.display==='block')?'none':'block'; input.value=playlist.join('\n'); });
  apply.addEventListener('click', ()=>{ const ids=input.value.split('\n').map(s=>s.trim()).filter(Boolean); if(ids.length){ playlist=ids; feedIndex=0; } panel.style.display='none'; });
  shuffle.addEventListener('click', ()=>{ for(let i=playlist.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [playlist[i],playlist[j]]=[playlist[j],playlist[i]]; } input.value=playlist.join('\n'); });
  close.addEventListener('click', ()=> panel.style.display='none');
  setTimeout(()=>{ const hint=document.getElementById('swipe-hint'); if(hint) hint.style.display='none'; }, 2800);
  updateHUD();
  animate();
}

function firstInteractOnce(){ initAudio(); }

function onTouchStart(e){ if(gameOver) return; isSwiping=true; touchStartY = e.touches ? e.touches[0].clientY : e.clientY; touchStartX = e.touches ? e.touches[0].clientX : e.clientX; }
function onTouchMove(e){ if(!isSwiping||gameOver) return; const x = e.touches ? e.touches[0].clientX : e.clientX; const dx = x - touchStartX; if(falling && !falling.settled && Math.abs(dx)>28){ const dir = dx>0?1:-1; falling.body.applyImpulse(new CANNON.Vec3(dir*2,0,0), falling.body.position); playSound('nudge'); haptic('light'); touchStartX=x; e.preventDefault(); } }
function onTouchEnd(e){ if(!isSwiping||gameOver) return; const y = e.changedTouches ? e.changedTouches[0].clientY : e.clientY; const dy = touchStartY - y; if(dy>50 && !falling){ dropTV(); e.preventDefault(); } isSwiping=false; }

function nextVideoId(){ if(!playlist.length) return 'M7lc1UVf-VE'; const id = playlist[feedIndex % playlist.length]; feedIndex++; return id; }

function createTV(y=5){
  const group=new THREE.Group();
  const shellGeo=new THREE.BoxGeometry(TV.w,TV.h,TV.d); const shellMat=new THREE.MeshStandardMaterial({color:0x1a1a1a,roughness:.7,metalness:.3}); const shell=new THREE.Mesh(shellGeo,shellMat); shell.castShadow=true; shell.receiveShadow=true; group.add(shell);
  const bezelGeo=new THREE.PlaneGeometry(SCREEN.w,SCREEN.h); const bezelMat=new THREE.MeshBasicMaterial({color:0x020202}); const bezel=new THREE.Mesh(bezelGeo,bezelMat); bezel.position.set(0,0,TV.d/2 + 0.001); group.add(bezel);
  const ledGeo=new THREE.PlaneGeometry(0.028,0.028); const ledMat=new THREE.MeshBasicMaterial({color:0x00ff00}); const led=new THREE.Mesh(ledGeo,ledMat); led.position.set(TV.w*0.35,-TV.h*0.35, TV.d/2 + 0.002); group.add(led);
  const shape=new CANNON.Box(new CANNON.Vec3(TV.w/2, TV.h/2, TV.d/2)); const body=new CANNON.Body({mass:1, shape, sleepSpeedLimit:.1, sleepTimeLimit:.5}); body.position.set(group.position.x,y,group.position.z); body.linearDamping=.32; body.angularDamping=.34; world.addBody(body);
  const screenEl=document.createElement('div'); screenEl.style.width=(SCREEN.w*260).toFixed(0)+'px'; screenEl.style.height=(SCREEN.h*260).toFixed(0)+'px'; screenEl.style.pointerEvents='none'; screenEl.style.border='0';
  const iframe=document.createElement('iframe'); iframe.setAttribute('allow','autoplay; encrypted-media; picture-in-picture;'); iframe.setAttribute('frameborder','0'); iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0'; const vid=nextVideoId(); iframe.src=`https://www.youtube.com/embed/${vid}?autoplay=1&mute=1&controls=0&playsinline=1&enablejsapi=1&loop=1&playlist=${vid}`; screenEl.appendChild(iframe);
  const cssObj=new THREE.CSS3DObject(screenEl); cssObj.position.set(0,0, TV.d/2 + 0.002); const cssPivot=new THREE.Object3D(); cssPivot.add(cssObj); cssScene.add(cssPivot);
  const unit={ group, body, cssPivot, cssObj, iframeEl:iframe, yt:null, settled:false, led };
  scene.add(group); tvs.push(unit);
  const tryBind=()=>{ if(!youTubeReady) return; unit.yt=new YT.Player(iframe,{ events:{ onReady:(e)=>{ if(muted) e.target.mute(); e.target.setLoop(true); } }, playerVars:{ autoplay:1, controls:0, modestbranding:1, rel:0, playsinline:1, mute: muted?1:1, loop:1, playlist: vid } }); };
  setTimeout(tryBind, 400);
  playSound('drop'); haptic('medium');
  return unit;
}

function dropTV(){ if(gameOver||falling) return; const y = tvs.length ? Math.max(...tvs.map(t=>t.group.position.y)) + TV.h + GAP_Y + 2 : 5; falling=createTV(y); }

function cullBottom(){ if(!tvs.length||gameOver) return; const bottom=tvs.shift(); scene.remove(bottom.group); cssScene.remove(bottom.cssPivot); world.removeBody(bottom.body); if(bottom.yt){ try{ bottom.yt.stopVideo(); bottom.yt.destroy(); }catch(e){} } streak=0; updateHUD(); haptic('medium'); }

function calcStability(){ if(tvs.length<2) return 1; const recent=tvs.slice(-6).filter(t=>t.settled); if(recent.length<2) return 1; let comOff=0, overhang=0; for(let i=1;i<recent.length;i++){ const a=recent[i], b=recent[i-1]; const dx=a.body.position.x - b.body.position.x; const dz=a.body.position.z - b.body.position.z; const off=Math.sqrt(dx*dx+dz*dz); comOff += off/PHYS_LIMIT; const oh=Math.max(0, off - TV.w*0.30); overhang += oh/(TV.w*0.70); } const n=recent.length-1; return Math.max(0, Math.min(1, 1 - (comOff/n + STAB_ALPHA*(overhang/n)))); }

function collapse(){ if(gameOver) return; gameOver=true; world.gravity.y *= .35; playSound('collapse'); haptic('error'); const top=tvs.slice(-3); top.forEach(t=>{ const imp=new CANNON.Vec3((Math.random()-.5)*5, Math.random()*3, (Math.random()-.5)*5); t.body.applyImpulse(imp, t.body.position); }); const shards=[]; for(let i=0;i<48;i++){ const geo=new THREE.BoxGeometry(.05,.05,.05); const mat=new THREE.MeshStandardMaterial({color:0x333333}); const mesh=new THREE.Mesh(geo,mat); mesh.castShadow=true; const origin = top.length ? top[(Math.random()*top.length)|0].group.position : new THREE.Vector3(0,2,0); mesh.position.set(origin.x+(Math.random()-.5)*2, origin.y+Math.random()*2, origin.z+(Math.random()-.5)*2); scene.add(mesh); const shape=new CANNON.Box(new CANNON.Vec3(.025,.025,.025)); const body=new CANNON.Body({mass:.12, shape}); body.position.set(mesh.position.x,mesh.position.y,mesh.position.z); body.velocity.set((Math.random()-.5)*8, Math.random()*8, (Math.random()-.5)*8); body.angularVelocity.set((Math.random()-.5)*10, (Math.random()-.5)*10, (Math.random()-.5)*10); world.addBody(body); shards.push({mesh, body}); }
  setTimeout(()=>{ shards.forEach(s=>{ scene.remove(s.mesh); world.removeBody(s.body); }); }, SHARD_TTL);
  if(score>highScore){ highScore=score; localStorage.setItem('tv_stacker_high', String(highScore)); }
  setTimeout(()=>{ document.getElementById('final-score').innerHTML = `SCORE: ${score}<br>HEIGHT: ${height.toFixed(2)}m<br>STREAK: ${streak}Ã—`; document.getElementById('game-over').style.display='flex'; }, 900);
}

function restart(){ tvs.forEach(t=>{ scene.remove(t.group); cssScene.remove(t.cssPivot); world.removeBody(t.body); if(t.yt){ try{ t.yt.stopVideo(); t.yt.destroy(); }catch(e){} } }); tvs=[]; falling=null; score=0; height=0; streak=0; stability=1; gameOver=false; feedIndex=0; world.gravity.y=-9.8; document.getElementById('game-over').style.display='none'; updateHUD(); haptic('success'); }

function updatePlaybackBudget(){ const sorted=[...tvs].sort((a,b)=> b.group.position.y - a.group.position.y); const allowed=new Set(sorted.slice(0,6)); tvs.forEach(t=>{ const play=allowed.has(t); if(t.yt && t.yt.getPlayerState){ try{ if(play){ if(muted) t.yt.mute(); const st=t.yt.getPlayerState(); if(st!==1) t.yt.playVideo(); } else { t.yt.pauseVideo(); } }catch(e){} } }); }

function toggleMute(){ muted=!muted; document.getElementById('btn-mute').textContent = muted ? 'ðŸ”‡':'ðŸ”Š'; tvs.forEach(t=>{ if(t.yt){ try{ if(muted) t.yt.mute(); else t.yt.unMute(); }catch(e){} } }); haptic('light'); }

function cycleMode(){ MODE=(MODE+1)%MODES.length; const btn=document.getElementById('btn-mode'); btn.textContent = `MODE: ${MODES[MODE]}`; if(MODES[MODE]==='GAME'){ world.gravity.y=-12; } else if(MODES[MODE]==='GALLERY'){ world.gravity.y=-7; } else { world.gravity.y=-9.8; } }

function toggleAutofall(){ autofallOn=!autofallOn; const btn=document.getElementById('btn-autofall'); btn.textContent = `AUTOFALL: ${autofallOn?'ON':'OFF'}`; if(autofallOn){ if(autofallTimer) clearInterval(autofallTimer); autofallTimer=setInterval(()=>{ if(!falling && !gameOver) dropTV(); }, AUTOFALL_INTERVAL); } else { if(autofallTimer) clearInterval(autofallTimer); autofallTimer=null; } }

function onResize(){ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); cssRenderer.setSize(window.innerWidth, window.innerHeight); }

function animate(){ requestAnimationFrame(animate); const dt=Math.min(clock.getDelta(), .1); world.step(1/60, dt, 3);
  for(const t of tvs){ t.group.position.copy(t.body.position); t.group.quaternion.copy(t.body.quaternion); if(!t.settled && t.body.sleepState===CANNON.Body.SLEEPING){ t.settled=true; if(t===falling){ const bonus=Math.floor(t.body.position.y*10); score += 10+bonus; streak++; score += streak*2; falling=null; playSound('land'); haptic('success'); } } if(t.settled){ height=Math.max(height, t.body.position.y); }
    t.cssPivot.position.copy(t.group.position); t.cssPivot.quaternion.copy(t.group.quaternion); t.cssObj.position.set(0,0, TV.d/2 + 0.002);
    const time=clock.elapsedTime; t.led.material.color.setHex(Math.sin(time*5)>0?0x00ff00:0x003300);
  }
  stability=calcStability(); if(stability<0 && !gameOver) collapse();
  updatePlaybackBudget(); updateHUD(); renderer.render(scene,camera); cssRenderer.render(cssScene,camera);
}

if (typeof THREE!=='undefined' && typeof CANNON!=='undefined'){ setTimeout(init, 300); } else { setTimeout(init, 600); }
</script>
</body>
</html>
