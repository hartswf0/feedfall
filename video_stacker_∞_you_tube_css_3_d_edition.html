<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>VIDEO_STACKER_∞ — YouTube CSS3D Edition</title>
<style>
  :root{
    --ink:#0f0; --bg:#000; --panel:#0a0a0a; --line:#003300;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Courier New", monospace;
    overflow:hidden; touch-action:none; -webkit-user-select:none; user-select:none;
  }
  #gl,#css{position:fixed; inset:0;}

  /* HUD — minimal chips */
  #hud{position:fixed; top:env(safe-area-inset-top,12px); left:env(safe-area-inset-left,12px); z-index:20; display:flex; gap:8px; align-items:center; pointer-events:none}
  .chip{border:1px solid var(--ink); padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.6); box-shadow:0 0 10px rgba(0,255,0,.15)}
  #stability{position:relative; width:88px; height:6px; border-radius:4px; overflow:hidden; border:1px solid var(--ink); background:#111;}
  #stability>i{position:absolute; inset:0; width:100%; background:linear-gradient(90deg,#f33,#ff0,#0f0); transform-origin:left center; transform:scaleX(1)}

  /* Floating controls */
  #controls{position:fixed; right:env(safe-area-inset-right,10px); top:50%; transform:translateY(-50%); display:flex; flex-direction:column; gap:10px; z-index:30}
  .btn{width:52px; height:52px; border-radius:999px; border:1px solid var(--ink); background:rgba(0,0,0,.7); color:var(--ink); display:grid; place-items:center; font-weight:700; box-shadow:0 0 14px rgba(0,255,0,.25); cursor:pointer; touch-action:manipulation}
  .btn:active{background:var(--ink); color:#000; transform:scale(.95)}
  .btn.small{width:44px; height:44px; font-size:12px}

  /* Drop button bottom-center */
  #dropWrap{position:fixed; left:50%; bottom:env(safe-area-inset-bottom,18px); transform:translateX(-50%); z-index:30}
  #btn-drop{width:72px; height:72px; font-size:22px; letter-spacing:1px}

  /* Swipe hint */
  #hint{position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,18px) + 92px); transform:translateX(-50%); opacity:.6; z-index:20; animation:pulse 2s infinite; pointer-events:none}
  @keyframes pulse{0%,100%{opacity:.6}50%{opacity:.25}}

  /* Game Over */
  #over{position:fixed; inset:0; display:none; place-items:center; z-index:50;}
  #over .panel{background:rgba(0,0,0,.9); border:2px solid var(--ink); padding:24px 20px; width:min(88vw,420px); text-align:center; box-shadow:0 0 30px rgba(0,255,0,.35)}
  #over h1{margin:0 0 8px; letter-spacing:2px}
  #over .meta{opacity:.85; margin:10px 0 18px}
  #over button{border:1px solid var(--ink); background:transparent; color:var(--ink); padding:10px 20px; font-weight:700; border-radius:999px; cursor:pointer}
  #over button:active{background:var(--ink); color:#000}

  /* Tiny caption for installation mode */
  #label{position:fixed; right:12px; bottom:12px; font-size:10px; opacity:.6; letter-spacing:.5px; z-index:10; pointer-events:none}

  /* Performance: keep iframes hitless (gestures over canvas) */
  .yt-surface{pointer-events:none; border-radius:8px; overflow:hidden; border:1px solid #0b0b0b; box-shadow:0 0 8px rgba(0,0,0,.6)}
</style>
</head>
<body>
  <div id="gl"></div>
  <div id="css"></div>

  <div id="hud">
    <div class="chip" id="score">0</div>
    <div class="chip" id="height">0.0m</div>
    <div class="chip" id="streak">×0</div>
    <div id="stability" class="chip" aria-label="stability"><i></i></div>
    <div class="chip" id="next">next: —</div>
  </div>

  <div id="controls">
    <button class="btn" id="btn-view" title="View">⟲</button>
    <button class="btn" id="btn-auto" title="Auto">▶︎</button>
    <button class="btn" id="btn-mute" title="Mute beeps">🔊</button>
    <button class="btn small" id="btn-mode" title="Exhibit mode">◇</button>
    <button class="btn small" id="btn-cull" title="Cull bottom">✕</button>
  </div>

  <div id="dropWrap"><button class="btn" id="btn-drop" title="Drop">⬇</button></div>
  <div id="hint">↑ swipe up to drop · ◀ ▶ swipe to nudge</div>

  <div id="over"><div class="panel">
    <h1>COLLAPSE</h1>
    <div class="meta" id="final"></div>
    <button id="btn-restart">RESTART</button>
  </div></div>

  <div id="label">VIDEO_STACKER_∞ — play / platform / installation</div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/renderers/CSS3DRenderer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

<script>
// ======= CONFIG =======
const TV = { w:0.64, h:0.42, d:0.46 }; // box size
const SCREEN_RATIO = 16/9;
const DROP_SPAWN_Y = 5;
const GAP_Y = 0.05;
const LIMIT = 0.22; // stability threshold
const K = 6, ALPHA = 0.7;
const AUTODROP_INTERVAL = 2000; // ms
const MAX_ACTIVE_PLAYERS = 6;   // keep only last N playing for perf

// A small seed list—replace with your own IDs
const VIDEO_IDS = [
  "dQw4w9WgXcQ","xvFZjo5PgG0","9bZkp7q19f0","3JZ_D3ELwOQ","RgKAFK5djSk",
  "CevxZvSJLk8","fJ9rUzIMcZQ","YbJOTdZBX1g","E7wJTI-1dvQ","60ItHLz5WEA"
];

// ======= STATE =======
let scene, cssScene, camera, renderer, cssRenderer, world, clock;
let tvUnits = []; // {body, mesh, cssObj, player, settled}
let score=0, height=0, streak=0, high=parseInt(localStorage.getItem('vs_hi')||'0');
let stability=1, gameOver=false, muted=false, auto=true, exhibit=false;
let camPreset=0, falling=null, feedIndex=0, autoTimer=null;
let audioCtx, sounds={};
let YT_READY=false, pendingPlayerCbs=[];

// ======= YT API READY =======
window.onYouTubeIframeAPIReady = () => { YT_READY = true; pendingPlayerCbs.splice(0).forEach(fn=>fn()); };

// ======= AUDIO (UI beeps only) =======
function initAudio(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const blip=(f1=400,f2=200, t=0.15, g=0.2)=>{const o=audioCtx.createOscillator(); const g1=audioCtx.createGain(); o.connect(g1); g1.connect(audioCtx.destination); o.frequency.setValueAtTime(f1,audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(f2,audioCtx.currentTime+t); g1.gain.setValueAtTime(g,audioCtx.currentTime); g1.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+t); o.start(); o.stop(audioCtx.currentTime+t);};
  sounds.drop=()=>blip(320,160,.18,.25);
  sounds.land=()=>blip(220,120,.12,.18);
  sounds.nudge=()=>blip(520,480,.06,.12);
  sounds.collapse=()=>blip(240,40,.6,.35);
}
function play(name){ if(!muted && audioCtx && sounds[name]) try{sounds[name]()}catch{} }

// ======= HAPTICS =======
const vibe = (p)=> navigator.vibrate && navigator.vibrate(p||10);

// ======= CAMERA PRESETS =======
const CAMS=[
  {pos:[0,2.2,4.2],look:[0,1,0]},
  {pos:[-2.8,2.6,3.6],look:[0,1,0]},
  {pos:[2.8,2.6,3.6],look:[0,1,0]},
  {pos:[0,1.0,3.5],look:[0,1.2,0]},
  {pos:[0,5.2,0.2],look:[0,0.6,0]},
];

// ======= INIT =======
function init(){
  clock = new THREE.Clock();
  // scenes
  scene = new THREE.Scene(); scene.background = new THREE.Color(0x050805); scene.fog = new THREE.Fog(0x050805, 6, 16);
  cssScene = new THREE.Scene();

  // camera
  camera = new THREE.PerspectiveCamera(50, innerWidth/innerHeight, 0.1, 100);
  setCam(0);

  // renderers
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setPixelRatio(Math.min(devicePixelRatio,1.5));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  document.getElementById('gl').appendChild(renderer.domElement);

  cssRenderer = new THREE.CSS3DRenderer();
  cssRenderer.setSize(innerWidth, innerHeight);
  cssRenderer.domElement.style.pointerEvents = 'none';
  document.getElementById('css').appendChild(cssRenderer.domElement);

  // lights
  scene.add(new THREE.AmbientLight(0x224422, 1.2));
  const key=new THREE.DirectionalLight(0xffffff, 0.9); key.position.set(3,6,4); key.castShadow=true; scene.add(key);
  const rim=new THREE.DirectionalLight(0x55aaff, 0.25); rim.position.set(-3,2,-2); scene.add(rim);

  // physics
  world = new CANNON.World();
  world.gravity.set(0,-9.82,0);
  world.broadphase = new CANNON.SAPBroadphase(world);
  world.allowSleep = true;
  world.defaultContactMaterial.friction=0.6; world.defaultContactMaterial.restitution=0.05;

  // floor
  const floorShape=new CANNON.Plane();
  const floorBody=new CANNON.Body({mass:0, shape:floorShape});
  floorBody.quaternion.setFromEuler(-Math.PI/2,0,0);
  world.addBody(floorBody);

  const floorGeo=new THREE.PlaneGeometry(20,20);
  const floorMat=new THREE.MeshStandardMaterial({color:0x0b0b0b, roughness:.95});
  const floor=new THREE.Mesh(floorGeo,floorMat); floor.rotation.x=-Math.PI/2; floor.receiveShadow=true; scene.add(floor);

  const grid=new THREE.GridHelper(12,24,0x003300,0x001a00); grid.position.y=0.01; scene.add(grid);

  // events
  addEvents();

  // audio activation on first tap
  window.addEventListener('pointerdown', ()=>{ if(!audioCtx) initAudio(); }, {once:true});

  // start
  updateHUD();
  armAuto(true);
  animate();
}

// ======= EVENTS & INPUT =======
let touchStart={x:0,y:0}, swiping=false;
function addEvents(){
  window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); cssRenderer.setSize(innerWidth,innerHeight); });

  window.addEventListener('pointerdown', (e)=>{ touchStart.x=e.clientX; touchStart.y=e.clientY; swiping=true; });
  window.addEventListener('pointermove', (e)=>{
    if(!swiping||gameOver) return;
    const dx=e.clientX-touchStart.x, dy=touchStart.y-e.clientY;
    if(falling && !falling.settled && Math.abs(dx)>24){ nudge(Math.sign(dx)); touchStart.x=e.clientX; }
  });
  window.addEventListener('pointerup', (e)=>{
    if(!swiping||gameOver) return; swiping=false;
    const dy=touchStart.y-e.clientY; if(dy>48) drop();
  });

  // buttons
  id('btn-drop').onclick=()=>drop();
  id('btn-view').onclick=()=>{ camPreset=(camPreset+1)%CAMS.length; setCam(camPreset); vibe(10); };
  id('btn-auto').onclick=()=>{ auto=!auto; armAuto(auto); vibe(10); };
  id('btn-mute').onclick=()=>{ muted=!muted; id('btn-mute').textContent = muted? '🔇':'🔊'; vibe(10); };
  id('btn-cull').onclick=()=>{ cullBottom(); vibe(20); };
  id('btn-mode').onclick=()=>{ exhibit=!exhibit; document.getElementById('label').style.opacity=exhibit?.9:.6; vibe([10,40,10]); };
  id('btn-restart').onclick=restart;
}
function id(x){ return document.getElementById(x); }

// ======= CAMERA =======
function setCam(i){ const c=CAMS[i]; camera.position.set(...c.pos); camera.lookAt(new THREE.Vector3(...c.look)); }

// ======= UTIL =======
function nextVideo(){ const id = VIDEO_IDS[feedIndex % VIDEO_IDS.length]; feedIndex++; id('next').textContent = 'next: '+id; return id; }

// ======= CREATE A TV (WebGL shell + CSS3D YouTube surface) =======
function makeTV(y=DROP_SPAWN_Y){
  // WebGL group
  const g = new THREE.Group();
  const shell = new THREE.Mesh(
    new THREE.BoxGeometry(TV.w, TV.h, TV.d),
    new THREE.MeshStandardMaterial({color:0x121212, roughness:.8, metalness:.25})
  ); shell.castShadow=true; shell.receiveShadow=true; g.add(shell);

  // Bezel lip for subtle highlight
  const bezel = new THREE.Mesh(new THREE.BoxGeometry(TV.w*0.86, TV.h*0.72, 0.02), new THREE.MeshStandardMaterial({color:0x0a0a0a, roughness:.7}));
  bezel.position.z = TV.d/2 + 0.01; g.add(bezel);

  // Physics body
  const shape = new CANNON.Box(new CANNON.Vec3(TV.w/2, TV.h/2, TV.d/2));
  const body = new CANNON.Body({mass:1, shape, sleepSpeedLimit:.1, sleepTimeLimit:.4});
  body.position.set(0,y,0); body.linearDamping=.3; body.angularDamping=.3; world.addBody(body);

  // CSS3D YouTube plane
  const pxW = 384, pxH = Math.round(pxW/SCREEN_RATIO);
  const surface = document.createElement('div');
  surface.className='yt-surface';
  surface.style.width=pxW+'px'; surface.style.height=pxH+'px'; surface.style.background='#000';

  // create player using API (autoplay muted loop)
  let player=null; const makePlayer=()=>{
    player = new YT.Player(surface, { width:pxW, height:pxH, videoId: nextVideo(), playerVars:{autoplay:1, controls:0, modestbranding:1, rel:0, playsinline:1, mute:1, loop:1, playlist: VIDEO_IDS[(feedIndex-1)%VIDEO_IDS.length]}, events:{ onReady:(e)=>{try{e.target.mute(); e.target.playVideo();}catch{}} }});
  };
  if(YT_READY) makePlayer(); else pendingPlayerCbs.push(makePlayer);

  const cssObj = new THREE.CSS3DObject(surface);
  const scale = (TV.w*0.86) / pxW; // px -> world units mapping
  cssObj.scale.set(scale, scale, 1);
  cssObj.position.z = TV.d/2 + 0.012; // float just above bezel

  // assemble
  const unit={group:g, body, css:cssObj, player, settled:false, lastPlay:Date.now()};
  g.position.y = y; scene.add(g); cssScene.add(cssObj);
  return unit;
}

// ======= DROP / NUDGE / CULL =======
function drop(){ if(gameOver||falling) return; falling = makeTV(spawnY()); tvUnits.push(falling); play('drop'); vibe(20); limitActivePlayers(); }
function spawnY(){ return (tvUnits.length? Math.max(...tvUnits.map(u=>u.group.position.y))+TV.h+GAP_Y : DROP_SPAWN_Y) + 1.5; }
function nudge(dir){ if(!falling||falling.settled) return; falling.body.applyImpulse(new CANNON.Vec3(dir*2,0,0), falling.body.position); play('nudge'); }
function cullBottom(){ if(!tvUnits.length) return; const u=tvUnits.shift(); scene.remove(u.group); cssScene.remove(u.css); world.removeBody(u.body); try{u.player&&u.player.destroy()}catch{} streak=0; updateHUD(); }

// ======= STABILITY & COLLAPSE =======
function calcStability(){ if(tvUnits.length<2) return 1; const recent=tvUnits.slice(-K).filter(u=>u.settled); if(recent.length<2) return 1; let com=0, over=0; for(let i=1;i<recent.length;i++){ const a=recent[i], b=recent[i-1]; const dx=a.body.position.x-b.body.position.x, dz=a.body.position.z-b.body.position.z; const off=Math.hypot(dx,dz); com += off/LIMIT; const oh=Math.max(0, off - TV.w*0.30); over += oh/(TV.w*0.7); } const avgCom=com/(recent.length-1), avgOver=over/(recent.length-1); return Math.max(0, Math.min(1, 1-(avgCom+ALPHA*avgOver))); }
function collapse(){ if(gameOver) return; gameOver=true; world.gravity.y *= 0.3; play('collapse'); vibe([40,80,40]); if(score>high){ high=score; localStorage.setItem('vs_hi', String(high)); }
  setTimeout(()=>{ id('final').innerHTML = `SCORE: ${score}<br>HEIGHT: ${height.toFixed(2)}m<br>STREAK: ${streak}`; id('over').style.display='grid'; }, 900);
}

// ======= AUTO MODE =======
function armAuto(on){ id('btn-auto').textContent = on? '⏸':'▶︎'; clearInterval(autoTimer); if(on){ autoTimer=setInterval(()=>{ if(!falling && !gameOver) drop(); }, AUTODROP_INTERVAL); } }

// ======= RESTART =======
function restart(){ tvUnits.forEach(u=>{ scene.remove(u.group); cssScene.remove(u.css); world.removeBody(u.body); try{u.player&&u.player.destroy()}catch{} }); tvUnits.length=0; falling=null; score=0;height=0;streak=0;stability=1;gameOver=false; feedIndex=0; world.gravity.y=-9.82; id('over').style.display='none'; updateHUD(); }

// ======= ACTIVE PLAYERS THROTTLE =======
function limitActivePlayers(){ const active=tvUnits.slice(-MAX_ACTIVE_PLAYERS); const inactive=tvUnits.slice(0, Math.max(0, tvUnits.length-MAX_ACTIVE_PLAYERS)); inactive.forEach(u=>{ try{u.player && u.player.pauseVideo && u.player.pauseVideo();}catch{} }); active.forEach(u=>{ try{u.player && u.player.playVideo && u.player.playVideo();}catch{} }); }

// ======= HUD =======
function updateHUD(){ id('score').textContent = score; id('height').textContent = height.toFixed(1)+'m'; id('streak').textContent = '×'+streak; id('stability').firstElementChild.style.transform = `scaleX(${Math.max(0,stability)})`; }

// ======= ANIMATE =======
function animate(){ requestAnimationFrame(animate); const dt=Math.min(clock.getDelta(), .1); world.step(1/60, dt, 3);
  const t=clock.getElapsedTime();

  // drift camera in exhibit mode
  if(exhibit){ camera.position.x = Math.sin(t*.2)*2.2; camera.position.z = 3.8 + Math.cos(t*.15)*0.6; camera.lookAt(0,1.1,0); }

  // sync bodies → meshes → css
  tvUnits.forEach(u=>{
    u.group.position.copy(u.body.position); u.group.quaternion.copy(u.body.quaternion);
    u.css.position.copy(u.body.position.clone().add(new THREE.Vector3(0,0,0.001))); // tiny offset
    u.css.quaternion.copy(u.body.quaternion);

    // settle detection
    if(!u.settled && u.body.sleepState === CANNON.Body.SLEEPING){
      u.settled = true; if(u===falling){
        const bonus = Math.floor(u.body.position.y*10); score += 10 + bonus; streak++; score += streak*2; falling=null; play('land'); vibe([10,30,10]); limitActivePlayers(); }
    }
    if(u.settled) height = Math.max(height, u.body.position.y);
  });

  stability = calcStability();
  if(stability<=0 && !gameOver) collapse();

  updateHUD();
  renderer.render(scene,camera); cssRenderer.render(cssScene,camera);
}

// ======= GO =======
init();
</script>
</body>
</html>
